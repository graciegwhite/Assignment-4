---
title: "Assignment 4"
author: "Gracie White"
date: "November 12, 2018"
always_allow_html: yes
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
# Install necessary packages
library(tidyverse)
library(pwr)
library(knitr)
library(kableExtra)
library(plotly)
library(extrafont)
library(ggrepel)
library(vcdExtra)
library(car)
library(shiny)
library(effsize)
library(leaflet)

# Load Datasets
lobster_size_df <- read_csv("lobster_size_abundance.csv")
traps_df <- read_csv("lobster_traps.csv")

```
##INTRODUCTION

##DATA AND METHODS

##RESULTS AND DISCUSSION

*Lobster Abundance and Fishing Pressure*
```{r, echo=FALSE}
# Fishing Pressure
# First, filter the data so we only keep relevant info
traps5_df <- traps_df %>%
  select(YEAR, MONTH, FISHING_SEASON, SITE, TRAPS) %>%
  filter(SITE == "CARP" | SITE == "AQUE" | SITE == "IVEE" | SITE == "NAPL" | SITE == "MOHK") %>%
  group_by(SITE, YEAR) 
  
# Summary table of lobster traps each year by site  
trap5_sumtable <- summarize(traps5_df, med_traps = median(TRAPS), max_traps = max(TRAPS), mean_traps = mean(TRAPS), sd_traps = sd(TRAPS), sample_size = length(TRAPS)) %>% 
# Write in report that we took mean of traps/year 
# Write 

# Line graph of mean lobster traps by year for each site
traps_line_g <- ggplot(trap5_sumtable, aes(x = YEAR, y = mean_traps, group = SITE, color = SITE)) +
  geom_line(size = 1, alpha = 0.8, aes(linetype = MPA)) +
  theme_classic() +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  labs(x = "Year", y = "Mean Lobster Traps", title = "Average Lobster Traps (2012-2017)")

traps_line_g

# looks like fishing pressure is decreasing over time. The drop after 2016 is probably a result of the decreased abundance seen in the next figure? Note that there are no traps in the MPA sites. 
```

```{r, echo=FALSE}

# Filter sites 
lobcount_allyears_df <- lobster_size_df %>% 
  filter(SITE == "AQUE"| SITE == "NAPL"| SITE == "MOHK"| SITE == "IVEE"| SITE == "CARP", COUNT != "0") %>% 
  select(YEAR, SITE, COUNT) %>% 
  group_by(SITE, YEAR)
#add up all lobster observations by site and year
lobcount <- aggregate(COUNT~SITE+YEAR, data = lobcount_allyears_df, sum) 
#Create column to specify if site is an MPA or not  
lobcount <- mutate(lobcount, MPA = ifelse(SITE == "IVEE" | SITE == "NAPL", "MPA", "No MPA")) %>% 
  group_by(SITE, YEAR)

#line graph of abundance by site
abundance_line_g <- ggplot(lobcount, aes(x = YEAR, y = COUNT, group = SITE, color = SITE)) +
  geom_line(size = 1, alpha = 0.8, aes(linetype = MPA)) +
  labs(x = "Year", y = "Number of Lobsters Observed", title = "Spiny Lobster Abundance in the Santa Barbara Channel (2012-2017)") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_classic()

abundance_line_g
#Abundance has recently increased in IVEE and CARP, but decreased or stayed similar at other sites. Why is there a peak in 2015, and an overall decrease in 2016? Was there an event that we should be aware of? Why is CARP increasing so much when it's not an MPA, and conversely, why is the NAPL MPA decreasing? Perhaps an El NiÃ±o event? A change in fishery regulations? A lobster disease? 
```


*Mean Lobster Size in 2017*
```{r, echo=FALSE}
# Reformat size data into tidy format
# Filter sites and omit counts of "0"
lsize_sites_df <- lobster_size_df %>% 
  filter(SITE == "AQUE"| SITE == "NAPL"| SITE == "MOHK"| SITE == "IVEE"| SITE == "CARP", COUNT != "0", YEAR == "2017") %>% 
  select(YEAR, SITE, SIZE, COUNT)


# Expand Rows
lsize_expanded <- uncount(lsize_sites_df, weights = COUNT, .remove = FALSE)

```


```{r, echo=FALSE}
# One variable (carapace length (mm)), 5 factors
# Perform one-sided ANOVA

# Run a Levene's test to assess variances
size_lt <- leveneTest(SIZE ~ SITE, data = lsize_expanded)

# Identify hypotheses
# H0: Means across all groups are equal
# HA: At least two group means differ significantly
size_aov <- aov(SIZE ~ SITE, data = lsize_expanded)
summary(size_aov)

# Sample means are this different because they were most likely drawn for different population
# H0: Means across all groups are equal
# HA: At least two group means differ significantly

# p-value is <0.05 -> Reject the null.  There is a significant difference in means.  
# Sample means are this different because they were most likely drawn for different population
# Use post-hoc testing to see which sites differ

# Identify hypotheses
# H0:  There is no significant difference in pairwise means
# HA: There is a significant difference in pairwise means
size_pht <- TukeyHSD(size_aov)
size_pht

# p-value is <0.05 for sites (NAPL-CARP), (NAPL-IVEE)
# Reject the null for sites (NAPL-CARP), (NAPL-IVEE)

# Create a box-plot for visual mean comparison
size_bp <- ggplot(lsize_expanded, aes(x = SITE, y = SIZE)) +
  geom_boxplot(aes(color = SITE)) +
  ggtitle("Lobster Carapace Lengths at 5 LTER Sites in the Santa Barbara Channel, 2017") +
  xlab("Site") +
  ylab("Carapace Length (mm)") +
  theme_classic() +
  scale_colour_brewer("Site", palette = "Set2")
size_bp

# Create a data summary table to compare means
size_sum_df <- lsize_expanded %>% 
  group_by(SITE) %>% 
  summarize(count = n(), 
    mean = mean(SIZE),
    sd = sd(SIZE))
size_sum_df
```

*Changes in Lobster Size from 2012-2017 in MPA and non-MPA sites*
```{r, echo=FALSE}
# MPA Sites: IVEE, NAPL
# Non-MPA Sites: AQUE, CARP, MOHK

# Reformat size data into tidy format
# Filter sites and omit counts of "0"
lsize_sitesmpa_df <- lobster_size_df %>% 
  filter(SITE == "AQUE"| SITE == "NAPL"| SITE == "MOHK"| SITE == "IVEE"| SITE == "CARP", COUNT != "0",
         YEAR == "2012"| YEAR == "2017") %>% 
  select(YEAR, SITE, SIZE, COUNT)


# Expand Rows
lsizempa_expanded <- uncount(lsize_sitesmpa_df, weights = COUNT, .remove = FALSE)

# For exploration purposes, perhaps a facet-wrapped histogram of size distributions?
# Probably should make it look prettier. Let's eventually pick a color theme on color brewer and coordinate all of our visuals! <- like that
size_hist <- ggplot(lsize_expanded, aes(x = SIZE)) +
  geom_histogram(bins = 15, aes(fill = SITE)) +
  facet_wrap(~ SITE, scale = "free") + 
  theme_classic() +
  theme(legend.position = "none") + 
  scale_y_continuous(expand = c(0,0))

# Looks normal, how about a qq?

size_qq <- ggplot(lsize_expanded, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE, scale = "free")

# Looks pretty normal

# Use t-tests to compare means

# Starting with MPA - IVEE

# Creating Vectors for F and T-test

IVEE_2012 <- lsizempa_expanded %>% 
  filter(SITE == "IVEE", YEAR == "2012") %>% 
  pull(SIZE)

IVEE_2017 <- lsizempa_expanded %>% 
  filter(YEAR == "2017",SITE == "IVEE") %>% 
  pull(SIZE)

# F Test
# H0: Variances are EQUAL
# HA: Variances are NOT equal

IVEE_ftest <- var.test(IVEE_2012, IVEE_2017)
IVEE_ftest

# P value = .307, so variances are considered EQUAL

# T-Test for IVEE
# H0: Samples are drawn from populations with the same mean
# HA: Samples are drawn from populations with different means

t_IVEE <- t.test(IVEE_2012, IVEE_2017, var.equal = TRUE)
t_IVEE

# P-value = .0599
# Retain Null that the samples are drawn from populations with the same means
# Sample Means (2012 = 66.07, 2017 = 71.45)

# Effect Size

eff_size_IVEE <- cohen.d(IVEE_2012, IVEE_2017)
eff_size_IVEE

# d-estimate: -0.377 (small)

# power test

power_IVEE <- pwr.t.test(n = 632, d = .377, sig.level = 0.05, power = NULL)
power_IVEE

# power = .999



# MPA - NAPL

# Creating Vectors for F and T-Tests

NAPL_2012 <- lsizempa_expanded %>% 
  filter(YEAR == "2012", SITE == "NAPL") %>% 
  pull(SIZE)

NAPL_2017 <- lsizempa_expanded %>% 
  filter(YEAR == "2017", SITE == "NAPL") %>% 
  pull(SIZE)

# F-Test
# H0: Variances are EQUAL
# HA: Variances are NOT equal

NAPL_ftest <- var.test(NAPL_2012, NAPL_2017)
NAPL_ftest

# P-value = 0.7685, so variances are considered EQUAL

# T-Test for NAPL
# H0: Samples are drawn from populations with the same mean
# HA: Samples are drawn from populations with different means

t_NAPL <- t.test(NAPL_2012, NAPL_2017, var.equal = TRUE)
t_NAPL

# P-Value = .5002
# Retain Null, samples are drawn from populations with the same means
# Sample means (2012 = 73, 2017 = 76.23)

# Effect Size

eff_size_NAPL <- cohen.d(NAPL_2012,NAPL_2017)
eff_size_NAPL

# d-estimate: -0.283 (small)

# power test

power_NAPL <- pwr.t.test(n = 118, d = .283, sig.level = 0.05, power = NULL)
power_NAPL

# power = .581



# NON-MPA

# NON MPA - AQUE

# Creating Vectors for F and T-Tests

AQUE_2012 <- lsizempa_expanded %>% 
  filter(YEAR == "2012", SITE == "AQUE") %>% 
  pull(SIZE)

AQUE_2017 <- lsizempa_expanded %>% 
  filter(YEAR == "2017", SITE == "AQUE") %>% 
  pull(SIZE)

# F-Test
# H0: Variances are EQUAL
# HA: Variances are NOT equal

AQUE_ftest <- var.test(AQUE_2012, AQUE_2017)
AQUE_ftest

# P-value = 0.298, so variances are considered EQUAL

# T-Test for NAPL
# H0: Samples are drawn from populations with the same mean
# HA: Samples are drawn from populations with different means

t_AQUE <- t.test(AQUE_2012, AQUE_2017, var.equal = TRUE)
t_AQUE

# P-Value = .2097
# Retain Null, samples are drawn from populations with the same means
# Sample means (2012 = 71, 2017 = 73.89)

# Effect Size

eff_size_AQUE <- cohen.d(AQUE_2012, AQUE_2017)
eff_size_AQUE

# d-estimate: -0.256 (small)

# power test

power_AQUE <- pwr.t.test(n = 105, d = .256, sig.level = 0.05, power = NULL)
power_AQUE

# power = .4548



# NON MPA - CARP

# Creating Vectors for F and T-Tests

CARP_2012 <- lsizempa_expanded %>% 
  filter(YEAR == "2012", SITE == "CARP") %>% 
  pull(SIZE)

CARP_2017 <- lsizempa_expanded %>% 
  filter(YEAR == "2017", SITE == "CARP") %>% 
  pull(SIZE)

# F-Test
# H0: Variances are EQUAL
# HA: Variances are NOT equal

CARP_ftest <- var.test(CARP_2012, CARP_2017)
CARP_ftest

# P-value = 0.204, so variances are considered EQUAL

# T-Test for CARP
# H0: Samples are drawn from populations with the same mean
# HA: Samples are drawn from populations with different means

t_CARP <- t.test(CARP_2012, CARP_2017, var.equal = TRUE)
t_CARP

# P-Value = .1819
# Retain Null, samples are drawn from populations with the same means
# Sample means (2012 = 74.36, 2017 = 72.23)

# Effect Size

eff_size_CARP <- cohen.d(CARP_2012, CARP_2017)
eff_size_CARP

# d-estimate: 0.159 (negligible)

# power test

power_CARP <- pwr.t.test(n = 783, d = .159, sig.level = 0.05, power = NULL)
power_CARP

# power = .882



# NON MPA - MOHK

# Creating Vectors for F and T-Tests

MOHK_2012 <- lsizempa_expanded %>% 
  filter(YEAR == "2012", SITE == "MOHK") %>% 
  pull(SIZE)

MOHK_2017 <- lsizempa_expanded %>% 
  filter(YEAR == "2017", SITE == "MOHK") %>% 
  pull(SIZE)

# F-Test
# H0: Variances are EQUAL
# HA: Variances are NOT equal

MOHK_ftest <- var.test(MOHK_2012, MOHK_2017)
MOHK_ftest

# P-value = 0.1509, so variances are considered EQUAL

# T-Test for NAPL
# H0: Samples are drawn from populations with the same mean
# HA: Samples are drawn from populations with different means

t_MOHK <- t.test(MOHK_2012, MOHK_2017, var.equal = TRUE)
t_MOHK

# P-Value = 6.27 e-05
# Reject Null, samples are drawn from populations with different means
# Sample means (2012 = 77.25, 2017 = 72)

# One-Sided T-Test for NAPL
# H0: The mean lobster size in 2012 is not greater than mean lobster size in 2017
# HA: The mean lobster size in 2012 is greater than the mean lobster size in 2017

onesided_t_MOHK <- t.test(MOHK_2012, MOHK_2017, var.equal = TRUE, alternative = "greater")
onesided_t_MOHK

# P-Value = 3.138e-05
# Reject Null, mean lobster size in 2012 is greater than mean lobster size in 2017

# Effect Size

eff_size_MOHK <- cohen.d(MOHK_2012, MOHK_2017)
eff_size_MOHK

# d-estimate: 0.5408 (medium)

# power test

power_MOHK <- pwr.t.test(n = 261, d = .5408, sig.level = 0.05, power = NULL)
power_MOHK

# power = .999


# Summary Table of means at location, each year

summary_lobster_size <- lsizempa_expanded %>% 
  group_by(SITE, YEAR) %>% 
  summarize(mean_lobs_size = mean(SIZE), sd = sd(SIZE), sample_size = length(SIZE))

summary_lobster_size


```


*Legal and Illegal Lobster Trapping in 2017*
```{r, echo=FALSE}
#chi-square test for independance
#The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? 
#first, set up a table of proportions for 2017. The table should have the sites as the the row names, and then the columns shoulf be the proportions below and above the legal minimum carapace size (82.6mm)

lsize_prop_table <- lsize_expanded %>% 
  select(-YEAR, -COUNT) %>% 
  mutate(Legality = ifelse(SIZE > 82.6, "Above Legal Minimum", "Below Legal Minimum")) %>% 
  count(SITE, Legality) %>% 
  spread(Legality, n) %>% 
  select(-SITE)

rownames(lsize_prop_table) <- c("AQUE", "CARP", "IVEE", "MOHK", "NAPL")

#H0:There is no different in proportions
#HA: There is a difference in proportions

#look at the actual proportions

lob_prop <- prop.table(as.matrix(lsize_prop_table), 1)

#run a chi-square test for independence 

lsize_x2 <- chisq.test(lsize_prop_table)
lsize_x2

#p-value = 0.0009864, reject the null! We have significant evidence to suggest there is a difference in proportions of lobsters above/below the legal size limit between sites
```

 #in console, running lsize_x2$stdres to see which sites differ significantly:
 Above Legal Minimum Below Legal Minimum
AQUE           0.1464223          -0.1464223
CARP           1.8631463          -1.8631463
IVEE          -1.2357993           1.2357993
MOHK          -3.2327773           3.2327773
NAPL           2.5706474          -2.5706474

Standardized residuals greater than |2| indicate significance (I think?)

###So, we can say that the proportions between legal/illegal lobster size is differant at MOHK and NAPL. At MOHK, 87% of lobsters observed were smaller than the legal limit. At NAPL (an MPA), only 66% of lobsters were below the legal limit. The other three sites had between 74-78% of their lobsters below the legal size limit. 

```{r, echo=FALSE}
#Making a neat Kable Table of the proportions 


lob_prob_table <- kable(lob_prop, digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) 

lob_prob_table

```

```{r}
map <- read_csv("Long Lat.csv")
my_map <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=map$Longtitude, lat=map$Latitude, popup="LTER Site")

my_map
```

##CONCLUSION

##REFERENCES